"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _Utils = require("./Utils");

var _Utils2 = _interopRequireDefault(_Utils);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var App = function () {
  _createClass(App, null, [{
    key: "PATH",

    /**
     * Provides access to the `applications` version 2 endpoint.
     */
    get: function get() {
      return "/v2/applications";
    }
    /**
     * @param {Credentials} credentials
     *    credentials to be used when interacting with the API.
     * @param {Object} options
     *    Addition App options.
     */

  }]);

  function App(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    _classCallCheck(this, App);

    this.creds = credentials;
    this.options = options;
  }

  _createClass(App, [{
    key: "_convertMethodSignature",
    value: function _convertMethodSignature(name, type, answerUrl, eventUrl, options) {
      var capability = {};
      switch (type) {
        case "voice":
          capability = {
            voice: {
              webhooks: {
                answer_url: {
                  address: answerUrl,
                  http_method: "GET"
                },
                event_url: {
                  address: eventUrl,
                  http_method: "POST"
                }
              }
            }
          };
          break;
        case "messages":
          capability = {
            messages: {
              webhooks: {
                inbound_url: {
                  address: options.inbound_url,
                  http_method: "POST"
                },
                status_url: {
                  address: options.status_url,
                  http_method: "POST"
                }
              }
            }
          };
          break;
        case "rtc":
          capability = {
            rtc: {
              webhooks: {
                event_url: {
                  address: eventUrl,
                  http_method: "POST"
                }
              }
            }
          };
          break;
      }

      return {
        name: name,
        capabilities: capability
      };
    }
  }, {
    key: "_convertApplicationResponse",
    value: function _convertApplicationResponse(application) {
      for (var capability in application.capabilities) {
        application[capability] = {
          webhooks: []
        };
        for (var webhook in application.capabilities[capability].webhooks) {
          application[capability].webhooks.push({
            endpoint_type: webhook,
            endpoint: application.capabilities[capability].webhooks[webhook].address,
            http_method: application.capabilities[capability].webhooks[webhook].http_method
          });
        }
      }

      delete application.capabilities;
      return application;
    }
  }, {
    key: "_convertApplicationListResponse",
    value: function _convertApplicationListResponse(applicationResponseHandler) {
      return function (response) {
        response.count = response.total_items;
        response.page_index = response.page;
        for (var i in response._embedded.applications) {
          response._embedded.applications[i] = applicationResponseHandler(response._embedded.applications[i]);
        }

        return response;
      };
    }

    /**
     * TODO: document
     */

  }, {
    key: "create",
    value: function create(name, type, answerUrl, eventUrl, options, callback) {
      var params = {};
      var responseParser = null;

      if (arguments.length > 2) {
        params = JSON.stringify(this._convertMethodSignature(name, type, answerUrl, eventUrl, options));
        responseParser = this._convertApplicationResponse;
      } else {
        params = JSON.stringify(name);
        callback = type;
      }

      var authorization = this.creds.apiKey + ":" + this.creds.apiSecret;

      var config = {
        host: this.options.apiHost || "api.nexmo.com",
        path: App.PATH,
        method: "POST",
        body: params,
        headers: {
          "Content-Type": "application/json",
          Authorization: "Basic " + Buffer.from(authorization).toString("base64")
        }
      };

      this.options.httpClient.request(config, callback, callback, false, responseParser);
    }

    /**
     * TODO: document
     */

  }, {
    key: "get",
    value: function get(params, callback) {
      var v2 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;

      var authorization = this.creds.apiKey + ":" + this.creds.apiSecret;
      var responseParser = null;

      if ((typeof params === "undefined" ? "undefined" : _typeof(params)) !== "object") {
        responseParser = this._convertApplicationResponse;
      } else {
        responseParser = this._convertApplicationListResponse(this._convertApplicationResponse);
      }

      if (v2) {
        responseParser = null;
      }

      var config = {
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils2.default.createPathWithQuery(App.PATH, params),
        method: "GET",
        body: undefined,
        headers: {
          "Content-Type": "application/json",
          Authorization: "Basic " + Buffer.from(authorization).toString("base64")
        }
      };

      this.options.httpClient.request(config, callback, callback, false, responseParser);
    }

    /**
     * TODO: document
     */

  }, {
    key: "update",
    value: function update(appId, name, type, answerUrl, eventUrl, options, callback) {
      var params = {};
      var responseParser = null;
      if (arguments.length > 3) {
        params = JSON.stringify(this._convertMethodSignature(name, type, answerUrl, eventUrl, options));
        responseParser = this._convertApplicationResponse;
      } else {
        params = JSON.stringify(name);
        callback = type;
      }

      var authorization = this.creds.apiKey + ":" + this.creds.apiSecret;

      var config = {
        host: this.options.apiHost || "api.nexmo.com",
        path: App.PATH + "/" + appId,
        method: "PUT",
        body: params,
        headers: {
          "Content-Type": "application/json",
          Authorization: "Basic " + Buffer.from(authorization).toString("base64")
        }
      };

      this.options.httpClient.request(config, callback, callback, false, responseParser);
    }

    /**
     * TODO: document
     */

  }, {
    key: "delete",
    value: function _delete(appId, callback) {
      var authorization = this.creds.apiKey + ":" + this.creds.apiSecret;

      var config = {
        host: this.options.apiHost || "api.nexmo.com",
        path: App.PATH + "/" + appId,
        method: "DELETE",
        body: "{}",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Basic " + Buffer.from(authorization).toString("base64")
        }
      };

      this.options.httpClient.request(config, callback);
    }
  }]);

  return App;
}();

exports.default = App;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHAuanMiXSwibmFtZXMiOlsiQXBwIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJuYW1lIiwidHlwZSIsImFuc3dlclVybCIsImV2ZW50VXJsIiwiY2FwYWJpbGl0eSIsInZvaWNlIiwid2ViaG9va3MiLCJhbnN3ZXJfdXJsIiwiYWRkcmVzcyIsImh0dHBfbWV0aG9kIiwiZXZlbnRfdXJsIiwibWVzc2FnZXMiLCJpbmJvdW5kX3VybCIsInN0YXR1c191cmwiLCJydGMiLCJjYXBhYmlsaXRpZXMiLCJhcHBsaWNhdGlvbiIsIndlYmhvb2siLCJwdXNoIiwiZW5kcG9pbnRfdHlwZSIsImVuZHBvaW50IiwiYXBwbGljYXRpb25SZXNwb25zZUhhbmRsZXIiLCJyZXNwb25zZSIsImNvdW50IiwidG90YWxfaXRlbXMiLCJwYWdlX2luZGV4IiwicGFnZSIsImkiLCJfZW1iZWRkZWQiLCJhcHBsaWNhdGlvbnMiLCJjYWxsYmFjayIsInBhcmFtcyIsInJlc3BvbnNlUGFyc2VyIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiSlNPTiIsInN0cmluZ2lmeSIsIl9jb252ZXJ0TWV0aG9kU2lnbmF0dXJlIiwiX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlIiwiYXV0aG9yaXphdGlvbiIsImFwaUtleSIsImFwaVNlY3JldCIsImNvbmZpZyIsImhvc3QiLCJhcGlIb3N0IiwicGF0aCIsIlBBVEgiLCJtZXRob2QiLCJib2R5IiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJodHRwQ2xpZW50IiwicmVxdWVzdCIsInYyIiwiX2NvbnZlcnRBcHBsaWNhdGlvbkxpc3RSZXNwb25zZSIsImNyZWF0ZVBhdGhXaXRoUXVlcnkiLCJ1bmRlZmluZWQiLCJhcHBJZCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7QUFFQTs7Ozs7Ozs7SUFFTUEsRzs7OztBQUNKOzs7d0JBR2tCO0FBQ2hCLGFBQU8sa0JBQVA7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ZUFEbkI7QUFFWEMsY0FBU2pELElBQUlrRCxJQUFiLFNBQXFCYyxLQUZWO0FBR1hiLGdCQUFRLEtBSEc7QUFJWEMsY0FBTWpCLE1BSks7QUFLWGtCLGlCQUFTO0FBQ1AsMEJBQWdCLGtCQURUO0FBRVBDLG9DQUF3QkMsT0FBT0MsSUFBUCxDQUFZYixhQUFaLEVBQTJCYyxRQUEzQixDQUFvQyxRQUFwQztBQUZqQjtBQUxFLE9BQWI7O0FBV0EsV0FBS3ZELE9BQUwsQ0FBYXdELFVBQWIsQ0FBd0JDLE9BQXhCLENBQ0ViLE1BREYsRUFFRVosUUFGRixFQUdFQSxRQUhGLEVBSUUsS0FKRixFQUtFRSxjQUxGO0FBT0Q7O0FBRUQ7Ozs7Ozs0QkFHTzRCLEssRUFBTzlCLFEsRUFBVTtBQUN0QixVQUFNUyxnQkFBbUIsS0FBS3hDLEtBQUwsQ0FBV3lDLE1BQTlCLFNBQXdDLEtBQUt6QyxLQUFMLENBQVcwQyxTQUF6RDs7QUFFQSxVQUFJQyxTQUFTO0FBQ1hDLGNBQU0sS0FBSzdDLE9BQUwsQ0FBYThDLE9BQWIsSUFBd0IsZUFEbkI7QUFFWEMsY0FBU2pELElBQUlrRCxJQUFiLFNBQXFCYyxLQUZWO0FBR1hiLGdCQUFRLFFBSEc7QUFJWEMsY0FBTSxJQUpLO0FBS1hDLGlCQUFTO0FBQ1AsMEJBQWdCLGtCQURUO0FBRVBDLG9DQUF3QkMsT0FBT0MsSUFBUCxDQUFZYixhQUFaLEVBQTJCYyxRQUEzQixDQUFvQyxRQUFwQztBQUZqQjtBQUxFLE9BQWI7O0FBV0EsV0FBS3ZELE9BQUwsQ0FBYXdELFVBQWIsQ0FBd0JDLE9BQXhCLENBQWdDYixNQUFoQyxFQUF3Q1osUUFBeEM7QUFDRDs7Ozs7O2tCQUdZbEMsRyIsImZpbGUiOiJBcHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL1V0aWxzXCI7XG5cbmNsYXNzIEFwcCB7XG4gIC8qKlxuICAgKiBQcm92aWRlcyBhY2Nlc3MgdG8gdGhlIGBhcHBsaWNhdGlvbnNgIHZlcnNpb24gMiBlbmRwb2ludC5cbiAgICovXG4gIHN0YXRpYyBnZXQgUEFUSCgpIHtcbiAgICByZXR1cm4gXCIvdjIvYXBwbGljYXRpb25zXCI7XG4gIH1cbiAgLyoqXG4gICAqIEBwYXJhbSB7Q3JlZGVudGlhbHN9IGNyZWRlbnRpYWxzXG4gICAqICAgIGNyZWRlbnRpYWxzIHRvIGJlIHVzZWQgd2hlbiBpbnRlcmFjdGluZyB3aXRoIHRoZSBBUEkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gICAqICAgIEFkZGl0aW9uIEFwcCBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoY3JlZGVudGlhbHMsIG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuY3JlZHMgPSBjcmVkZW50aWFscztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgX2NvbnZlcnRNZXRob2RTaWduYXR1cmUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucykge1xuICAgIGxldCBjYXBhYmlsaXR5ID0ge307XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIFwidm9pY2VcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICB2b2ljZToge1xuICAgICAgICAgICAgd2ViaG9va3M6IHtcbiAgICAgICAgICAgICAgYW5zd2VyX3VybDoge1xuICAgICAgICAgICAgICAgIGFkZHJlc3M6IGFuc3dlclVybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJHRVRcIlxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBldmVudF91cmw6IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiBldmVudFVybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJQT1NUXCJcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwibWVzc2FnZXNcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICBtZXNzYWdlczoge1xuICAgICAgICAgICAgd2ViaG9va3M6IHtcbiAgICAgICAgICAgICAgaW5ib3VuZF91cmw6IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiBvcHRpb25zLmluYm91bmRfdXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBzdGF0dXNfdXJsOiB7XG4gICAgICAgICAgICAgICAgYWRkcmVzczogb3B0aW9ucy5zdGF0dXNfdXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJydGNcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICBydGM6IHtcbiAgICAgICAgICAgIHdlYmhvb2tzOiB7XG4gICAgICAgICAgICAgIGV2ZW50X3VybDoge1xuICAgICAgICAgICAgICAgIGFkZHJlc3M6IGV2ZW50VXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogbmFtZSxcbiAgICAgIGNhcGFiaWxpdGllczogY2FwYWJpbGl0eVxuICAgIH07XG4gIH1cblxuICBfY29udmVydEFwcGxpY2F0aW9uUmVzcG9uc2UoYXBwbGljYXRpb24pIHtcbiAgICBmb3IgKGxldCBjYXBhYmlsaXR5IGluIGFwcGxpY2F0aW9uLmNhcGFiaWxpdGllcykge1xuICAgICAgYXBwbGljYXRpb25bY2FwYWJpbGl0eV0gPSB7XG4gICAgICAgIHdlYmhvb2tzOiBbXVxuICAgICAgfTtcbiAgICAgIGZvciAobGV0IHdlYmhvb2sgaW4gYXBwbGljYXRpb24uY2FwYWJpbGl0aWVzW2NhcGFiaWxpdHldLndlYmhvb2tzKSB7XG4gICAgICAgIGFwcGxpY2F0aW9uW2NhcGFiaWxpdHldLndlYmhvb2tzLnB1c2goe1xuICAgICAgICAgIGVuZHBvaW50X3R5cGU6IHdlYmhvb2ssXG4gICAgICAgICAgZW5kcG9pbnQ6XG4gICAgICAgICAgICBhcHBsaWNhdGlvbi5jYXBhYmlsaXRpZXNbY2FwYWJpbGl0eV0ud2ViaG9va3Nbd2ViaG9va10uYWRkcmVzcyxcbiAgICAgICAgICBodHRwX21ldGhvZDpcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uLmNhcGFiaWxpdGllc1tjYXBhYmlsaXR5XS53ZWJob29rc1t3ZWJob29rXS5odHRwX21ldGhvZFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBkZWxldGUgYXBwbGljYXRpb24uY2FwYWJpbGl0aWVzO1xuICAgIHJldHVybiBhcHBsaWNhdGlvbjtcbiAgfVxuXG4gIF9jb252ZXJ0QXBwbGljYXRpb25MaXN0UmVzcG9uc2UoYXBwbGljYXRpb25SZXNwb25zZUhhbmRsZXIpIHtcbiAgICByZXR1cm4gcmVzcG9uc2UgPT4ge1xuICAgICAgcmVzcG9uc2UuY291bnQgPSByZXNwb25zZS50b3RhbF9pdGVtcztcbiAgICAgIHJlc3BvbnNlLnBhZ2VfaW5kZXggPSByZXNwb25zZS5wYWdlO1xuICAgICAgZm9yIChsZXQgaSBpbiByZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zKSB7XG4gICAgICAgIHJlc3BvbnNlLl9lbWJlZGRlZC5hcHBsaWNhdGlvbnNbaV0gPSBhcHBsaWNhdGlvblJlc3BvbnNlSGFuZGxlcihcbiAgICAgICAgICByZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zW2ldXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBjcmVhdGUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICBsZXQgcGFyYW1zID0ge307XG4gICAgbGV0IHJlc3BvbnNlUGFyc2VyID0gbnVsbDtcblxuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikge1xuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHRoaXMuX2NvbnZlcnRNZXRob2RTaWduYXR1cmUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucylcbiAgICAgICk7XG4gICAgICByZXNwb25zZVBhcnNlciA9IHRoaXMuX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShuYW1lKTtcbiAgICAgIGNhbGxiYWNrID0gdHlwZTtcbiAgICB9XG5cbiAgICBjb25zdCBhdXRob3JpemF0aW9uID0gYCR7dGhpcy5jcmVkcy5hcGlLZXl9OiR7dGhpcy5jcmVkcy5hcGlTZWNyZXR9YDtcblxuICAgIHZhciBjb25maWcgPSB7XG4gICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgIHBhdGg6IEFwcC5QQVRILFxuICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgIGJvZHk6IHBhcmFtcyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWBcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIGNvbmZpZyxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBmYWxzZSxcbiAgICAgIHJlc3BvbnNlUGFyc2VyXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgZ2V0KHBhcmFtcywgY2FsbGJhY2ssIHYyID0gZmFsc2UpIHtcbiAgICBjb25zdCBhdXRob3JpemF0aW9uID0gYCR7dGhpcy5jcmVkcy5hcGlLZXl9OiR7dGhpcy5jcmVkcy5hcGlTZWNyZXR9YDtcbiAgICBsZXQgcmVzcG9uc2VQYXJzZXIgPSBudWxsO1xuXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgIHJlc3BvbnNlUGFyc2VyID0gdGhpcy5fY29udmVydEFwcGxpY2F0aW9uUmVzcG9uc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3BvbnNlUGFyc2VyID0gdGhpcy5fY29udmVydEFwcGxpY2F0aW9uTGlzdFJlc3BvbnNlKFxuICAgICAgICB0aGlzLl9jb252ZXJ0QXBwbGljYXRpb25SZXNwb25zZVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAodjIpIHtcbiAgICAgIHJlc3BvbnNlUGFyc2VyID0gbnVsbDtcbiAgICB9XG5cbiAgICB2YXIgY29uZmlnID0ge1xuICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KEFwcC5QQVRILCBwYXJhbXMpLFxuICAgICAgbWV0aG9kOiBcIkdFVFwiLFxuICAgICAgYm9keTogdW5kZWZpbmVkLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJhc2ljICR7QnVmZmVyLmZyb20oYXV0aG9yaXphdGlvbikudG9TdHJpbmcoXCJiYXNlNjRcIil9YFxuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgY29uZmlnLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBjYWxsYmFjayxcbiAgICAgIGZhbHNlLFxuICAgICAgcmVzcG9uc2VQYXJzZXJcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICB1cGRhdGUoYXBwSWQsIG5hbWUsIHR5cGUsIGFuc3dlclVybCwgZXZlbnRVcmwsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9O1xuICAgIGxldCByZXNwb25zZVBhcnNlciA9IG51bGw7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAzKSB7XG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgdGhpcy5fY29udmVydE1ldGhvZFNpZ25hdHVyZShuYW1lLCB0eXBlLCBhbnN3ZXJVcmwsIGV2ZW50VXJsLCBvcHRpb25zKVxuICAgICAgKTtcbiAgICAgIHJlc3BvbnNlUGFyc2VyID0gdGhpcy5fY29udmVydEFwcGxpY2F0aW9uUmVzcG9uc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KG5hbWUpO1xuICAgICAgY2FsbGJhY2sgPSB0eXBlO1xuICAgIH1cblxuICAgIGNvbnN0IGF1dGhvcml6YXRpb24gPSBgJHt0aGlzLmNyZWRzLmFwaUtleX06JHt0aGlzLmNyZWRzLmFwaVNlY3JldH1gO1xuXG4gICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgcGF0aDogYCR7QXBwLlBBVEh9LyR7YXBwSWR9YCxcbiAgICAgIG1ldGhvZDogXCJQVVRcIixcbiAgICAgIGJvZHk6IHBhcmFtcyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWBcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIGNvbmZpZyxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBmYWxzZSxcbiAgICAgIHJlc3BvbnNlUGFyc2VyXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgZGVsZXRlKGFwcElkLCBjYWxsYmFjaykge1xuICAgIGNvbnN0IGF1dGhvcml6YXRpb24gPSBgJHt0aGlzLmNyZWRzLmFwaUtleX06JHt0aGlzLmNyZWRzLmFwaVNlY3JldH1gO1xuXG4gICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgcGF0aDogYCR7QXBwLlBBVEh9LyR7YXBwSWR9YCxcbiAgICAgIG1ldGhvZDogXCJERUxFVEVcIixcbiAgICAgIGJvZHk6IFwie31cIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWBcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChjb25maWcsIGNhbGxiYWNrKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBBcHA7XG4iXX0=