"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _Utils = require("./Utils");

var _Utils2 = _interopRequireDefault(_Utils);

var _ShortCode = require("./ShortCode");

var _ShortCode2 = _interopRequireDefault(_ShortCode);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var querystring = require("querystring");

var Message = function () {
  _createClass(Message, null, [{
    key: "ERROR_MESSAGES",
    get: function get() {
      return {
        sender: "Invalid from address",
        to: "Invalid to address",
        msg: "Invalid Text Message",
        body: "Invalid Body value in Binary Message",
        udh: "Invalid udh value in Binary Message",
        title: "Invalid title in WAP Push message",
        url: "Invalid url in WAP Push message"
      };
    }
  }, {
    key: "PATH",
    get: function get() {
      return "/sms/json";
    }

    /**
     * @param {Credentials} credentials
     *    credentials to be used when interacting with the API.
     * @param {Object} options
     *    Addition SMS options.
     */

  }]);

  function Message(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    _classCallCheck(this, Message);

    this.creds = credentials;
    this.options = options;

    var _shortcode = new _ShortCode2.default(this.creds, this.options);

    this.shortcodeAlert = _shortcode.shortcodeAlert.bind(_shortcode);
    this.shortcode2FA = _shortcode.shortcode2FA.bind(_shortcode);
    this.shortcodeMarketing = _shortcode.shortcodeMarketing.bind(_shortcode);
  }

  _createClass(Message, [{
    key: "_sendRequest",
    value: function _sendRequest(endpoint, method, callback) {
      endpoint.path = endpoint.path + (endpoint.path.indexOf("?") > 0 ? "&" : "?") + querystring.stringify({
        api_key: this.creds.apiKey,
        api_secret: this.creds.apiSecret
      });
      this.options.httpClient.request(endpoint, method, callback);
    }
  }, {
    key: "_sendMessage",
    value: function _sendMessage(data, callback) {
      if (!data.from) {
        _Utils2.default.sendError(callback, new Error(Message.ERROR_MESSAGES.sender));
      } else if (!data.to) {
        _Utils2.default.sendError(callback, new Error(Message.ERROR_MESSAGES.to));
      } else {
        var path = Message.PATH + "?" + querystring.stringify(data);
        this.options.logger.info("sending message from " + data.from + " to " + data.to + " with message " + data.text);
        this._sendRequest({
          host: this.options.restHost || "rest.nexmo.com",
          path: path
        }, "POST", function (err, apiResponse) {
          if (!err && apiResponse.status && apiResponse.messages[0].status > 0) {
            _Utils2.default.sendError(callback, new Error(apiResponse.messages[0]["error-text"]), apiResponse);
          } else {
            if (callback) callback(err, apiResponse);
          }
        });
      }
    }

    /**
     * TODO: document
     */

  }, {
    key: "sendSms",
    value: function sendSms(sender, recipient, message, opts, callback) {
      if (!message) {
        _Utils2.default.sendError(callback, new Error(Message.ERROR_MESSAGES.msg));
      } else {
        if (!callback) {
          callback = opts;
          opts = {};
        }
        opts["from"] = sender;
        opts["to"] = recipient;
        opts["text"] = message;
        this._sendMessage(opts, callback);
      }
    }

    /**
     * TODO: document
     */

  }, {
    key: "sendBinaryMessage",
    value: function sendBinaryMessage(sender, recipient, body, udh, opts, callback) {
      if (!body) {
        _Utils2.default.sendError(callback, new Error(Message.ERROR_MESSAGES.body));
      } else if (!udh) {
        _Utils2.default.sendError(callback, new Error(Message.ERROR_MESSAGES.udh));
      } else {
        if (!callback) {
          callback = opts;
          opts = {};
        }
        opts["from"] = sender;
        opts["to"] = recipient;
        opts["type"] = "binary";
        opts["body"] = body;
        opts["udh"] = udh;
        this._sendMessage(opts, callback);
      }
    }

    /**
     * TODO: document
     */

  }, {
    key: "sendWapPushMessage",
    value: function sendWapPushMessage(sender, recipient, title, url, validity, opts, callback) {
      if (!title) {
        _Utils2.default.sendError(callback, new Error(Message.ERROR_MESSAGES.title));
      } else if (!url) {
        _Utils2.default.sendError(callback, new Error(Message.ERROR_MESSAGES.url));
      } else {
        if (typeof validity === "function") {
          callback = validity;
          opts = {};
          validity = 86400000;
        }
        if (typeof opts === "function") {
          callback = opts;
          opts = {};
        }
        opts["from"] = sender;
        opts["to"] = recipient;
        opts["type"] = "wappush";
        opts["title"] = title;
        opts["validity"] = validity;
        opts["url"] = url;
        this._sendMessage(opts, callback);
      }
    }
  }, {
    key: "search",
    value: function search(id, callback) {
      if (typeof id == "string") {
        return this.options.rest.get("/search/message", {
          id: id
        }, callback);
      }

      // Otherwise we expect an array
      return this.options.rest.get("/search/messages", {
        ids: id
      }, callback);
    }
  }, {
    key: "searchRejections",
    value: function searchRejections(to, date, callback) {
      return this.options.rest.get("/search/rejections", {
        to: to,
        date: date
      }, callback);
    }
  }]);

  return Message;
}();

exports.default = Message;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZXNzYWdlLmpzIl0sIm5hbWVzIjpbInF1ZXJ5c3RyaW5nIiwicmVxdWlyZSIsIk1lc3NhZ2UiLCJzZW5kZXIiLCJ0byIsIm1zZyIsImJvZHkiLCJ1ZGgiLCJ0aXRsZSIsInVybCIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiX3Nob3J0Y29kZSIsInNob3J0Y29kZUFsZXJ0IiwiYmluZCIsInNob3J0Y29kZTJGQSIsInNob3J0Y29kZU1hcmtldGluZyIsImVuZHBvaW50IiwibWV0aG9kIiwiY2FsbGJhY2siLCJwYXRoIiwiaW5kZXhPZiIsInN0cmluZ2lmeSIsImFwaV9rZXkiLCJhcGlLZXkiLCJhcGlfc2VjcmV0IiwiYXBpU2VjcmV0IiwiaHR0cENsaWVudCIsInJlcXVlc3QiLCJkYXRhIiwiZnJvbSIsInNlbmRFcnJvciIsIkVycm9yIiwiRVJST1JfTUVTU0FHRVMiLCJQQVRIIiwibG9nZ2VyIiwiaW5mbyIsInRleHQiLCJfc2VuZFJlcXVlc3QiLCJob3N0IiwicmVzdEhvc3QiLCJlcnIiLCJhcGlSZXNwb25zZSIsInN0YXR1cyIsIm1lc3NhZ2VzIiwicmVjaXBpZW50IiwibWVzc2FnZSIsIm9wdHMiLCJfc2VuZE1lc3NhZ2UiLCJ2YWxpZGl0eSIsImlkIiwicmVzdCIsImdldCIsImlkcyIsImRhdGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQUVBOzs7O0FBRUE7Ozs7Ozs7O0FBRUEsSUFBSUEsY0FBY0MsUUFBUSxhQUFSLENBQWxCOztJQUVNQyxPOzs7d0JBQ3dCO0FBQzFCLGFBQU87QUFDTEMsZ0JBQVEsc0JBREg7QUFFTEMsWUFBSSxvQkFGQztBQUdMQyxhQUFLLHNCQUhBO0FBSUxDLGNBQU0sc0NBSkQ7QUFLTEMsYUFBSyxxQ0FMQTtBQU1MQyxlQUFPLG1DQU5GO0FBT0xDLGFBQUs7QUFQQSxPQUFQO0FBU0Q7Ozt3QkFFaUI7QUFDaEIsYUFBTyxXQUFQO0FBQ0Q7O0FBRUQ7Ozs7Ozs7OztBQU1BLG1CQUFZQyxX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RUFLTC9CLFFBTEssQ0FBUDtBQU9EOzs7cUNBRWdCaEIsRSxFQUFJbUQsSSxFQUFNbkMsUSxFQUFVO0FBQ25DLGFBQU8sS0FBS1QsT0FBTCxDQUFheUMsSUFBYixDQUFrQkMsR0FBbEIsQ0FDTCxvQkFESyxFQUVMO0FBQ0VqRCxjQURGO0FBRUVtRDtBQUZGLE9BRkssRUFNTG5DLFFBTkssQ0FBUDtBQVFEOzs7Ozs7a0JBR1lsQixPIiwiZmlsZSI6Ik1lc3NhZ2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL1V0aWxzXCI7XG5cbmltcG9ydCBTaG9ydENvZGUgZnJvbSBcIi4vU2hvcnRDb2RlXCI7XG5cbnZhciBxdWVyeXN0cmluZyA9IHJlcXVpcmUoXCJxdWVyeXN0cmluZ1wiKTtcblxuY2xhc3MgTWVzc2FnZSB7XG4gIHN0YXRpYyBnZXQgRVJST1JfTUVTU0FHRVMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbmRlcjogXCJJbnZhbGlkIGZyb20gYWRkcmVzc1wiLFxuICAgICAgdG86IFwiSW52YWxpZCB0byBhZGRyZXNzXCIsXG4gICAgICBtc2c6IFwiSW52YWxpZCBUZXh0IE1lc3NhZ2VcIixcbiAgICAgIGJvZHk6IFwiSW52YWxpZCBCb2R5IHZhbHVlIGluIEJpbmFyeSBNZXNzYWdlXCIsXG4gICAgICB1ZGg6IFwiSW52YWxpZCB1ZGggdmFsdWUgaW4gQmluYXJ5IE1lc3NhZ2VcIixcbiAgICAgIHRpdGxlOiBcIkludmFsaWQgdGl0bGUgaW4gV0FQIFB1c2ggbWVzc2FnZVwiLFxuICAgICAgdXJsOiBcIkludmFsaWQgdXJsIGluIFdBUCBQdXNoIG1lc3NhZ2VcIlxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgZ2V0IFBBVEgoKSB7XG4gICAgcmV0dXJuIFwiL3Ntcy9qc29uXCI7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHNcbiAgICogICAgY3JlZGVudGlhbHMgdG8gYmUgdXNlZCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIEFQSS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAgICogICAgQWRkaXRpb24gU01TIG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICB2YXIgX3Nob3J0Y29kZSA9IG5ldyBTaG9ydENvZGUodGhpcy5jcmVkcywgdGhpcy5vcHRpb25zKTtcblxuICAgIHRoaXMuc2hvcnRjb2RlQWxlcnQgPSBfc2hvcnRjb2RlLnNob3J0Y29kZUFsZXJ0LmJpbmQoX3Nob3J0Y29kZSk7XG4gICAgdGhpcy5zaG9ydGNvZGUyRkEgPSBfc2hvcnRjb2RlLnNob3J0Y29kZTJGQS5iaW5kKF9zaG9ydGNvZGUpO1xuICAgIHRoaXMuc2hvcnRjb2RlTWFya2V0aW5nID0gX3Nob3J0Y29kZS5zaG9ydGNvZGVNYXJrZXRpbmcuYmluZChfc2hvcnRjb2RlKTtcbiAgfVxuXG4gIF9zZW5kUmVxdWVzdChlbmRwb2ludCwgbWV0aG9kLCBjYWxsYmFjaykge1xuICAgIGVuZHBvaW50LnBhdGggPVxuICAgICAgZW5kcG9pbnQucGF0aCArXG4gICAgICAoZW5kcG9pbnQucGF0aC5pbmRleE9mKFwiP1wiKSA+IDAgPyBcIiZcIiA6IFwiP1wiKSArXG4gICAgICBxdWVyeXN0cmluZy5zdHJpbmdpZnkoe1xuICAgICAgICBhcGlfa2V5OiB0aGlzLmNyZWRzLmFwaUtleSxcbiAgICAgICAgYXBpX3NlY3JldDogdGhpcy5jcmVkcy5hcGlTZWNyZXRcbiAgICAgIH0pO1xuICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoZW5kcG9pbnQsIG1ldGhvZCwgY2FsbGJhY2spO1xuICB9XG5cbiAgX3NlbmRNZXNzYWdlKGRhdGEsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFkYXRhLmZyb20pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMuc2VuZGVyKSk7XG4gICAgfSBlbHNlIGlmICghZGF0YS50bykge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy50bykpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgcGF0aCA9IE1lc3NhZ2UuUEFUSCArIFwiP1wiICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KGRhdGEpO1xuICAgICAgdGhpcy5vcHRpb25zLmxvZ2dlci5pbmZvKFxuICAgICAgICBcInNlbmRpbmcgbWVzc2FnZSBmcm9tIFwiICtcbiAgICAgICAgICBkYXRhLmZyb20gK1xuICAgICAgICAgIFwiIHRvIFwiICtcbiAgICAgICAgICBkYXRhLnRvICtcbiAgICAgICAgICBcIiB3aXRoIG1lc3NhZ2UgXCIgK1xuICAgICAgICAgIGRhdGEudGV4dFxuICAgICAgKTtcbiAgICAgIHRoaXMuX3NlbmRSZXF1ZXN0KFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLnJlc3RIb3N0IHx8IFwicmVzdC5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBwYXRoXG4gICAgICAgIH0sXG4gICAgICAgIFwiUE9TVFwiLFxuICAgICAgICBmdW5jdGlvbihlcnIsIGFwaVJlc3BvbnNlKSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgIWVyciAmJlxuICAgICAgICAgICAgYXBpUmVzcG9uc2Uuc3RhdHVzICYmXG4gICAgICAgICAgICBhcGlSZXNwb25zZS5tZXNzYWdlc1swXS5zdGF0dXMgPiAwXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgICAgICAgIGNhbGxiYWNrLFxuICAgICAgICAgICAgICBuZXcgRXJyb3IoYXBpUmVzcG9uc2UubWVzc2FnZXNbMF1bXCJlcnJvci10ZXh0XCJdKSxcbiAgICAgICAgICAgICAgYXBpUmVzcG9uc2VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyLCBhcGlSZXNwb25zZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZFNtcyhzZW5kZXIsIHJlY2lwaWVudCwgbWVzc2FnZSwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMubXNnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sgPSBvcHRzO1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1wiZnJvbVwiXSA9IHNlbmRlcjtcbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0ZXh0XCJdID0gbWVzc2FnZTtcbiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKG9wdHMsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlbmRCaW5hcnlNZXNzYWdlKHNlbmRlciwgcmVjaXBpZW50LCBib2R5LCB1ZGgsIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFib2R5KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLmJvZHkpKTtcbiAgICB9IGVsc2UgaWYgKCF1ZGgpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudWRoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sgPSBvcHRzO1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1wiZnJvbVwiXSA9IHNlbmRlcjtcbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0eXBlXCJdID0gXCJiaW5hcnlcIjtcbiAgICAgIG9wdHNbXCJib2R5XCJdID0gYm9keTtcbiAgICAgIG9wdHNbXCJ1ZGhcIl0gPSB1ZGg7XG4gICAgICB0aGlzLl9zZW5kTWVzc2FnZShvcHRzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZW5kV2FwUHVzaE1lc3NhZ2Uoc2VuZGVyLCByZWNpcGllbnQsIHRpdGxlLCB1cmwsIHZhbGlkaXR5LCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghdGl0bGUpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudGl0bGUpKTtcbiAgICB9IGVsc2UgaWYgKCF1cmwpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudXJsKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0eXBlb2YgdmFsaWRpdHkgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IHZhbGlkaXR5O1xuICAgICAgICBvcHRzID0ge307XG4gICAgICAgIHZhbGlkaXR5ID0gODY0MDAwMDA7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIG9wdHMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInR5cGVcIl0gPSBcIndhcHB1c2hcIjtcbiAgICAgIG9wdHNbXCJ0aXRsZVwiXSA9IHRpdGxlO1xuICAgICAgb3B0c1tcInZhbGlkaXR5XCJdID0gdmFsaWRpdHk7XG4gICAgICBvcHRzW1widXJsXCJdID0gdXJsO1xuICAgICAgdGhpcy5fc2VuZE1lc3NhZ2Uob3B0cywgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIHNlYXJjaChpZCwgY2FsbGJhY2spIHtcbiAgICBpZiAodHlwZW9mIGlkID09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICAgIFwiL3NlYXJjaC9tZXNzYWdlXCIsXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogaWRcbiAgICAgICAgfSxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gT3RoZXJ3aXNlIHdlIGV4cGVjdCBhbiBhcnJheVxuICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICBcIi9zZWFyY2gvbWVzc2FnZXNcIixcbiAgICAgIHtcbiAgICAgICAgaWRzOiBpZFxuICAgICAgfSxcbiAgICAgIGNhbGxiYWNrXG4gICAgKTtcbiAgfVxuXG4gIHNlYXJjaFJlamVjdGlvbnModG8sIGRhdGUsIGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5yZXN0LmdldChcbiAgICAgIFwiL3NlYXJjaC9yZWplY3Rpb25zXCIsXG4gICAgICB7XG4gICAgICAgIHRvLFxuICAgICAgICBkYXRlXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IE1lc3NhZ2U7XG4iXX0=