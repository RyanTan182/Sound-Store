"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _Utils = require("./Utils");

var _Utils2 = _interopRequireDefault(_Utils);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var NumberInsight = function () {
  _createClass(NumberInsight, null, [{
    key: "PATH",
    get: function get() {
      return "/ni/{type}/json";
    }
  }, {
    key: "ERROR_MESSAGES",
    get: function get() {
      return {
        numberInsightAdvancedValidation: "Missing Mandatory fields (number and/or callback url)",
        numberInsightValidation: "Missing Mandatory field - number",
        numberInsightPatternFailure: "Number can contain digits and may include any or all of the following: white space, -,+, (, )."
      };
    }
    /**
     * @param {Credentials} credentials
     *    credentials to be used when interacting with the API.
     * @param {Object} options
     *    Addition NumberInsight options.
     */

  }]);

  function NumberInsight(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    _classCallCheck(this, NumberInsight);

    this.creds = credentials;
    this.options = options;
  }

  /**
   * Get insight on the provided number.
   *
   * @param {Object} options - The options for Number Insight
   * @param {string} options.level - the level of insight: 'basic', 'standard'
   *                 or 'advanced'.
   *                 If no `level` value is provided, or an unrecognised value
   *                 is used, 'basic' level insight will be used.
   * @param {string} options.number - the phone number to retrieve insight on
   * @param {string} options.country - 'basic' and 'standard' only.
   *                 An ISO 3166 Alpha 2 country code
   *                 https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
   * @param {string} options. ip - 'advanced' only.
   *                 The IP address in IPv4 notation of the endpoint the
   *                 user connected from.
   * @param {Array}  options.features - 'advanced' only.
   *                 An Array detailing the information you want for this phone
   *                 number. Possible Array elements are:
   *                 - type: number is one of the following: mobile, landline,
   *                          landline_premium or unknown phone number.
   *                 - valid: number exists.
   *                 - reachable: is number available now.
   *                 - carrier: the MCCMNC for the carrier number is registered
   *                             with. This is either: <ISO country code>-FIXED
   *                             or <ISO country code>-PREMIUM.
   *                 - ported: if the user has changed carrier for number.
   *                 - roaming: the subscriber is outside their home network
   *
   * @param {string} options.callback - 'advanced' only.
   *                 The callback to be called when the API call completes.
   * @param {Number} options.callback_timeout - 'advanced' only.
   *                 The maximum wait until the Number Insight Return Parameters
   *                 are sent to callback. This is a value between 1000 - 30000ms
   *                 inclusive. The default is 30000 ms.
   * @param {string} options.callback_method - 'advanced' only.
   *                 The HTTP method used to send the Number Insight Return
   *                 Parameters to callback. Must be GET or POST. The default
   *                 value is GET.
   * @param {string} options.client_ref - 'advanced' only.
   *                 A 40 character reference string returned in the Number
   *                 Insight Return Parameters. This may be useful for your
   *                 internal reports.
   * @param {string} options['include-intermediate-callbacks'] - 'advanced' only.
   *                 Tells the Nexmo platform to make callbacks as soon as an
   *                 individual piece of information is retrieved.
   */


  _createClass(NumberInsight, [{
    key: "get",
    value: function get(options, callback) {
      var level = options.level;
      // remove 'level' as it's a library-only parameter
      delete options.level;

      if (level === "advanced" || level === "advancedAsync") {
        if (level === "advanced") {
          console.warn('DEPRECATION WARNING: Number Insight Advanced with a level of "advanced" will be synchronous in v2.0+. Consider using the level "advancedAsync" to keep using the async option.');
        }
        this._numberInsightAsync(options, callback);
      } else if (level === "advancedSync") {
        this._numberInsightCommon("advanced", options, callback);
      } else if (level === "standard") {
        this._numberInsightCommon("standard", options, callback);
      } else {
        this._numberInsightCommon("basic", options, callback);
      }
    }
  }, {
    key: "_numberInsightAsync",
    value: function _numberInsightAsync(inputParams, callback) {
      if (!inputParams.number || !inputParams.callback) {
        _Utils2.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightAdvancedValidation));
      } else {
        inputParams["api_key"] = this.creds.apiKey;
        inputParams["api_secret"] = this.creds.apiSecret;
        this.options.httpClient.request({
          host: this.options.apiHost || "api.nexmo.com",
          path: _Utils2.default.createPathWithQuery("" + NumberInsight.PATH.replace("{type}", "advanced/async"), inputParams)
        }, callback);
      }
    }
  }, {
    key: "_numberInsightCommon",
    value: function _numberInsightCommon(type, inputParams, callback) {
      if (this._validateNumber(inputParams, callback)) {
        var inputObj;
        if ((typeof inputParams === "undefined" ? "undefined" : _typeof(inputParams)) !== "object") {
          inputObj = {
            number: inputParams
          };
        } else {
          inputObj = inputParams;
        }
        inputObj["api_key"] = this.creds.apiKey;
        inputObj["api_secret"] = this.creds.apiSecret;
        this.options.httpClient.request({
          host: this.options.apiHost || "api.nexmo.com",
          path: _Utils2.default.createPathWithQuery("" + NumberInsight.PATH.replace("{type}", type), inputObj)
        }, callback);
      }
    }
  }, {
    key: "_validateNumber",
    value: function _validateNumber(inputParams, callback) {
      var numberPattern = new RegExp("^[0-9 +()-]*$");

      if ((typeof inputParams === "undefined" ? "undefined" : _typeof(inputParams)) === "object" && !inputParams.number) {
        _Utils2.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightValidation));
      } else if ((typeof inputParams === "undefined" ? "undefined" : _typeof(inputParams)) === "object" && !numberPattern.test(inputParams.number)) {
        _Utils2.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightPatternFailure));
      } else if ((typeof inputParams === "undefined" ? "undefined" : _typeof(inputParams)) !== "object" && (!inputParams || !numberPattern.test(inputParams))) {
        _Utils2.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightPatternFailure));
      }
      return true;
    }
  }]);

  return NumberInsight;
}();

exports.default = NumberInsight;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9OdW1iZXJJbnNpZ2h0LmpzIl0sIm5hbWVzIjpbIk51bWJlckluc2lnaHQiLCJudW1iZXJJbnNpZ2h0QWR2YW5jZWRWYWxpZGF0aW9uIiwibnVtYmVySW5zaWdodFZhbGlkYXRpb24iLCJudW1iZXJJbnNpZ2h0UGF0dGVybkZhaWx1cmUiLCJjcmVkZW50aWFscyIsIm9wdGlvbnMiLCJjcmVkcyIsImNhbGxiYWNrIiwibGV2ZWwiLCJjb25zb2xlIiwid2FybiIsIl9udW1iZXJJbnNpZ2h0QXN5bmMiLCJfbnVtYmVySW5zaWdodENvbW1vbiIsImlucHV0UGFyYW1zIiwibnVtYmVyIiwic2VuZEVycm9yIiwiRXJyb3IiLCJFUlJPUl9NRVNTQUdFUyIsImFwaUtleSIsImFwaVNlY3JldCIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwiaG9zdCIsImFwaUhvc3QiLCJwYXRoIiwiY3JlYXRlUGF0aFdpdGhRdWVyeSIsIlBBVEgiLCJyZXBsYWNlIiwidHlwZSIsIl92YWxpZGF0ZU51bWJlciIsImlucHV0T2JqIiwibnVtYmVyUGF0dGVybiIsIlJlZ0V4cCIsInRlc3QiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7O0FBRUE7Ozs7Ozs7O0lBRU1BLGE7Ozt3QkFDYztBQUNoQixhQUFPLGlCQUFQO0FBQ0Q7Ozt3QkFFMkI7QUFDMUIsYUFBTztBQUNMQyx5Q0FDRSx1REFGRztBQUdMQyxpQ0FBeUIsa0NBSHBCO0FBSUxDLHFDQUNFO0FBTEcsT0FBUDtBQU9EO0FBQ0Q7Ozs7Ozs7OztBQU1BLHlCQUFZQyxXQUFaLEVBQXVDO0FBQUEsUUFBZEMsT0FBYyx1RUFBSixFQUFJOztBQUFBOztBQUNyQyxTQUFLQyxLQUFMLEdBQWFGLFdBQWI7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWY7QUFDRDs7QUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7d0JBOENJQSxPLEVBQVNFLFEsRUFBVTtBQUNyQixVQUFJQyxRQUFR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QixJQUNBLENBQUNrQixjQUFjRSxJQUFkLENBQW1CcEIsWUFBWUMsTUFBL0IsQ0FGSSxFQUdMO0FBQ0Esd0JBQU1DLFNBQU4sQ0FDRVIsUUFERixFQUVFLElBQUlTLEtBQUosQ0FBVWhCLGNBQWNpQixjQUFkLENBQTZCZCwyQkFBdkMsQ0FGRjtBQUlELE9BUk0sTUFRQSxJQUNMLFFBQU9VLFdBQVAseUNBQU9BLFdBQVAsT0FBdUIsUUFBdkIsS0FDQyxDQUFDQSxXQUFELElBQWdCLENBQUNrQixjQUFjRSxJQUFkLENBQW1CcEIsV0FBbkIsQ0FEbEIsQ0FESyxFQUdMO0FBQ0Esd0JBQU1FLFNBQU4sQ0FDRVIsUUFERixFQUVFLElBQUlTLEtBQUosQ0FBVWhCLGNBQWNpQixjQUFkLENBQTZCZCwyQkFBdkMsQ0FGRjtBQUlEO0FBQ0QsYUFBTyxJQUFQO0FBQ0Q7Ozs7OztrQkFHWUgsYSIsImZpbGUiOiJOdW1iZXJJbnNpZ2h0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBVdGlscyBmcm9tIFwiLi9VdGlsc1wiO1xuXG5jbGFzcyBOdW1iZXJJbnNpZ2h0IHtcbiAgc3RhdGljIGdldCBQQVRIKCkge1xuICAgIHJldHVybiBcIi9uaS97dHlwZX0vanNvblwiO1xuICB9XG5cbiAgc3RhdGljIGdldCBFUlJPUl9NRVNTQUdFUygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbnVtYmVySW5zaWdodEFkdmFuY2VkVmFsaWRhdGlvbjpcbiAgICAgICAgXCJNaXNzaW5nIE1hbmRhdG9yeSBmaWVsZHMgKG51bWJlciBhbmQvb3IgY2FsbGJhY2sgdXJsKVwiLFxuICAgICAgbnVtYmVySW5zaWdodFZhbGlkYXRpb246IFwiTWlzc2luZyBNYW5kYXRvcnkgZmllbGQgLSBudW1iZXJcIixcbiAgICAgIG51bWJlckluc2lnaHRQYXR0ZXJuRmFpbHVyZTpcbiAgICAgICAgXCJOdW1iZXIgY2FuIGNvbnRhaW4gZGlnaXRzIGFuZCBtYXkgaW5jbHVkZSBhbnkgb3IgYWxsIG9mIHRoZSBmb2xsb3dpbmc6IHdoaXRlIHNwYWNlLCAtLCssICgsICkuXCJcbiAgICB9O1xuICB9XG4gIC8qKlxuICAgKiBAcGFyYW0ge0NyZWRlbnRpYWxzfSBjcmVkZW50aWFsc1xuICAgKiAgICBjcmVkZW50aWFscyB0byBiZSB1c2VkIHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgQVBJLlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiAgICBBZGRpdGlvbiBOdW1iZXJJbnNpZ2h0IG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGluc2lnaHQgb24gdGhlIHByb3ZpZGVkIG51bWJlci5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgb3B0aW9ucyBmb3IgTnVtYmVyIEluc2lnaHRcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnMubGV2ZWwgLSB0aGUgbGV2ZWwgb2YgaW5zaWdodDogJ2Jhc2ljJywgJ3N0YW5kYXJkJ1xuICAgKiAgICAgICAgICAgICAgICAgb3IgJ2FkdmFuY2VkJy5cbiAgICogICAgICAgICAgICAgICAgIElmIG5vIGBsZXZlbGAgdmFsdWUgaXMgcHJvdmlkZWQsIG9yIGFuIHVucmVjb2duaXNlZCB2YWx1ZVxuICAgKiAgICAgICAgICAgICAgICAgaXMgdXNlZCwgJ2Jhc2ljJyBsZXZlbCBpbnNpZ2h0IHdpbGwgYmUgdXNlZC5cbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnMubnVtYmVyIC0gdGhlIHBob25lIG51bWJlciB0byByZXRyaWV2ZSBpbnNpZ2h0IG9uXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmNvdW50cnkgLSAnYmFzaWMnIGFuZCAnc3RhbmRhcmQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBBbiBJU08gMzE2NiBBbHBoYSAyIGNvdW50cnkgY29kZVxuICAgKiAgICAgICAgICAgICAgICAgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSVNPXzMxNjYtMV9hbHBoYS0yXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLiBpcCAtICdhZHZhbmNlZCcgb25seS5cbiAgICogICAgICAgICAgICAgICAgIFRoZSBJUCBhZGRyZXNzIGluIElQdjQgbm90YXRpb24gb2YgdGhlIGVuZHBvaW50IHRoZVxuICAgKiAgICAgICAgICAgICAgICAgdXNlciBjb25uZWN0ZWQgZnJvbS5cbiAgICogQHBhcmFtIHtBcnJheX0gIG9wdGlvbnMuZmVhdHVyZXMgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBBbiBBcnJheSBkZXRhaWxpbmcgdGhlIGluZm9ybWF0aW9uIHlvdSB3YW50IGZvciB0aGlzIHBob25lXG4gICAqICAgICAgICAgICAgICAgICBudW1iZXIuIFBvc3NpYmxlIEFycmF5IGVsZW1lbnRzIGFyZTpcbiAgICogICAgICAgICAgICAgICAgIC0gdHlwZTogbnVtYmVyIGlzIG9uZSBvZiB0aGUgZm9sbG93aW5nOiBtb2JpbGUsIGxhbmRsaW5lLFxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZGxpbmVfcHJlbWl1bSBvciB1bmtub3duIHBob25lIG51bWJlci5cbiAgICogICAgICAgICAgICAgICAgIC0gdmFsaWQ6IG51bWJlciBleGlzdHMuXG4gICAqICAgICAgICAgICAgICAgICAtIHJlYWNoYWJsZTogaXMgbnVtYmVyIGF2YWlsYWJsZSBub3cuXG4gICAqICAgICAgICAgICAgICAgICAtIGNhcnJpZXI6IHRoZSBNQ0NNTkMgZm9yIHRoZSBjYXJyaWVyIG51bWJlciBpcyByZWdpc3RlcmVkXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoLiBUaGlzIGlzIGVpdGhlcjogPElTTyBjb3VudHJ5IGNvZGU+LUZJWEVEXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciA8SVNPIGNvdW50cnkgY29kZT4tUFJFTUlVTS5cbiAgICogICAgICAgICAgICAgICAgIC0gcG9ydGVkOiBpZiB0aGUgdXNlciBoYXMgY2hhbmdlZCBjYXJyaWVyIGZvciBudW1iZXIuXG4gICAqICAgICAgICAgICAgICAgICAtIHJvYW1pbmc6IHRoZSBzdWJzY3JpYmVyIGlzIG91dHNpZGUgdGhlaXIgaG9tZSBuZXR3b3JrXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmNhbGxiYWNrIC0gJ2FkdmFuY2VkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgVGhlIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBBUEkgY2FsbCBjb21wbGV0ZXMuXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLmNhbGxiYWNrX3RpbWVvdXQgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBUaGUgbWF4aW11bSB3YWl0IHVudGlsIHRoZSBOdW1iZXIgSW5zaWdodCBSZXR1cm4gUGFyYW1ldGVyc1xuICAgKiAgICAgICAgICAgICAgICAgYXJlIHNlbnQgdG8gY2FsbGJhY2suIFRoaXMgaXMgYSB2YWx1ZSBiZXR3ZWVuIDEwMDAgLSAzMDAwMG1zXG4gICAqICAgICAgICAgICAgICAgICBpbmNsdXNpdmUuIFRoZSBkZWZhdWx0IGlzIDMwMDAwIG1zLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy5jYWxsYmFja19tZXRob2QgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBUaGUgSFRUUCBtZXRob2QgdXNlZCB0byBzZW5kIHRoZSBOdW1iZXIgSW5zaWdodCBSZXR1cm5cbiAgICogICAgICAgICAgICAgICAgIFBhcmFtZXRlcnMgdG8gY2FsbGJhY2suIE11c3QgYmUgR0VUIG9yIFBPU1QuIFRoZSBkZWZhdWx0XG4gICAqICAgICAgICAgICAgICAgICB2YWx1ZSBpcyBHRVQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmNsaWVudF9yZWYgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBBIDQwIGNoYXJhY3RlciByZWZlcmVuY2Ugc3RyaW5nIHJldHVybmVkIGluIHRoZSBOdW1iZXJcbiAgICogICAgICAgICAgICAgICAgIEluc2lnaHQgUmV0dXJuIFBhcmFtZXRlcnMuIFRoaXMgbWF5IGJlIHVzZWZ1bCBmb3IgeW91clxuICAgKiAgICAgICAgICAgICAgICAgaW50ZXJuYWwgcmVwb3J0cy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnNbJ2luY2x1ZGUtaW50ZXJtZWRpYXRlLWNhbGxiYWNrcyddIC0gJ2FkdmFuY2VkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgVGVsbHMgdGhlIE5leG1vIHBsYXRmb3JtIHRvIG1ha2UgY2FsbGJhY2tzIGFzIHNvb24gYXMgYW5cbiAgICogICAgICAgICAgICAgICAgIGluZGl2aWR1YWwgcGllY2Ugb2YgaW5mb3JtYXRpb24gaXMgcmV0cmlldmVkLlxuICAgKi9cbiAgZ2V0KG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gICAgdmFyIGxldmVsID0gb3B0aW9ucy5sZXZlbDtcbiAgICAvLyByZW1vdmUgJ2xldmVsJyBhcyBpdCdzIGEgbGlicmFyeS1vbmx5IHBhcmFtZXRlclxuICAgIGRlbGV0ZSBvcHRpb25zLmxldmVsO1xuXG4gICAgaWYgKGxldmVsID09PSBcImFkdmFuY2VkXCIgfHwgbGV2ZWwgPT09IFwiYWR2YW5jZWRBc3luY1wiKSB7XG4gICAgICBpZiAobGV2ZWwgPT09IFwiYWR2YW5jZWRcIikge1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgJ0RFUFJFQ0FUSU9OIFdBUk5JTkc6IE51bWJlciBJbnNpZ2h0IEFkdmFuY2VkIHdpdGggYSBsZXZlbCBvZiBcImFkdmFuY2VkXCIgd2lsbCBiZSBzeW5jaHJvbm91cyBpbiB2Mi4wKy4gQ29uc2lkZXIgdXNpbmcgdGhlIGxldmVsIFwiYWR2YW5jZWRBc3luY1wiIHRvIGtlZXAgdXNpbmcgdGhlIGFzeW5jIG9wdGlvbi4nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aGlzLl9udW1iZXJJbnNpZ2h0QXN5bmMob3B0aW9ucywgY2FsbGJhY2spO1xuICAgIH0gZWxzZSBpZiAobGV2ZWwgPT09IFwiYWR2YW5jZWRTeW5jXCIpIHtcbiAgICAgIHRoaXMuX251bWJlckluc2lnaHRDb21tb24oXCJhZHZhbmNlZFwiLCBvcHRpb25zLCBjYWxsYmFjayk7XG4gICAgfSBlbHNlIGlmIChsZXZlbCA9PT0gXCJzdGFuZGFyZFwiKSB7XG4gICAgICB0aGlzLl9udW1iZXJJbnNpZ2h0Q29tbW9uKFwic3RhbmRhcmRcIiwgb3B0aW9ucywgY2FsbGJhY2spO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9udW1iZXJJbnNpZ2h0Q29tbW9uKFwiYmFzaWNcIiwgb3B0aW9ucywgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIF9udW1iZXJJbnNpZ2h0QXN5bmMoaW5wdXRQYXJhbXMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFpbnB1dFBhcmFtcy5udW1iZXIgfHwgIWlucHV0UGFyYW1zLmNhbGxiYWNrKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICBuZXcgRXJyb3IoTnVtYmVySW5zaWdodC5FUlJPUl9NRVNTQUdFUy5udW1iZXJJbnNpZ2h0QWR2YW5jZWRWYWxpZGF0aW9uKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaW5wdXRQYXJhbXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkcy5hcGlLZXk7XG4gICAgICBpbnB1dFBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRzLmFwaVNlY3JldDtcbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KFxuICAgICAgICAgICAgYCR7TnVtYmVySW5zaWdodC5QQVRILnJlcGxhY2UoXCJ7dHlwZX1cIiwgXCJhZHZhbmNlZC9hc3luY1wiKX1gLFxuICAgICAgICAgICAgaW5wdXRQYXJhbXNcbiAgICAgICAgICApXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIF9udW1iZXJJbnNpZ2h0Q29tbW9uKHR5cGUsIGlucHV0UGFyYW1zLCBjYWxsYmFjaykge1xuICAgIGlmICh0aGlzLl92YWxpZGF0ZU51bWJlcihpbnB1dFBhcmFtcywgY2FsbGJhY2spKSB7XG4gICAgICB2YXIgaW5wdXRPYmo7XG4gICAgICBpZiAodHlwZW9mIGlucHV0UGFyYW1zICE9PSBcIm9iamVjdFwiKSB7XG4gICAgICAgIGlucHV0T2JqID0ge1xuICAgICAgICAgIG51bWJlcjogaW5wdXRQYXJhbXNcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlucHV0T2JqID0gaW5wdXRQYXJhbXM7XG4gICAgICB9XG4gICAgICBpbnB1dE9ialtcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRzLmFwaUtleTtcbiAgICAgIGlucHV0T2JqW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZHMuYXBpU2VjcmV0O1xuICAgICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgICAgIHBhdGg6IFV0aWxzLmNyZWF0ZVBhdGhXaXRoUXVlcnkoXG4gICAgICAgICAgICBgJHtOdW1iZXJJbnNpZ2h0LlBBVEgucmVwbGFjZShcInt0eXBlfVwiLCB0eXBlKX1gLFxuICAgICAgICAgICAgaW5wdXRPYmpcbiAgICAgICAgICApXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIF92YWxpZGF0ZU51bWJlcihpbnB1dFBhcmFtcywgY2FsbGJhY2spIHtcbiAgICB2YXIgbnVtYmVyUGF0dGVybiA9IG5ldyBSZWdFeHAoXCJeWzAtOSArKCktXSokXCIpO1xuXG4gICAgaWYgKHR5cGVvZiBpbnB1dFBhcmFtcyA9PT0gXCJvYmplY3RcIiAmJiAhaW5wdXRQYXJhbXMubnVtYmVyKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICBuZXcgRXJyb3IoTnVtYmVySW5zaWdodC5FUlJPUl9NRVNTQUdFUy5udW1iZXJJbnNpZ2h0VmFsaWRhdGlvbilcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHR5cGVvZiBpbnB1dFBhcmFtcyA9PT0gXCJvYmplY3RcIiAmJlxuICAgICAgIW51bWJlclBhdHRlcm4udGVzdChpbnB1dFBhcmFtcy5udW1iZXIpXG4gICAgKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICBuZXcgRXJyb3IoTnVtYmVySW5zaWdodC5FUlJPUl9NRVNTQUdFUy5udW1iZXJJbnNpZ2h0UGF0dGVybkZhaWx1cmUpXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICB0eXBlb2YgaW5wdXRQYXJhbXMgIT09IFwib2JqZWN0XCIgJiZcbiAgICAgICghaW5wdXRQYXJhbXMgfHwgIW51bWJlclBhdHRlcm4udGVzdChpbnB1dFBhcmFtcykpXG4gICAgKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICBuZXcgRXJyb3IoTnVtYmVySW5zaWdodC5FUlJPUl9NRVNTQUdFUy5udW1iZXJJbnNpZ2h0UGF0dGVybkZhaWx1cmUpXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBOdW1iZXJJbnNpZ2h0O1xuIl19