"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _Utils = require("./Utils");

var _Utils2 = _interopRequireDefault(_Utils);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Voice = function () {
  _createClass(Voice, null, [{
    key: "ERROR_MESSAGES",
    get: function get() {
      return {
        to: "Invalid to address",
        msg: "Invalid Text Message",
        maxDigits: "Invalid max digits for TTS prompt",
        byeText: "Invalid bye text for TTS prompt",
        pinCode: "Invalid pin code for TTS confirm",
        failedText: "Invalid failed text for TTS confirm",
        answerUrl: "Invalid answer URL for call"
      };
    }
    /**
     * @param {Credentials} credentials
     *    credentials to be used when interacting with the API.
     * @param {Object} options
     *    Addition  options.
     */

  }]);

  function Voice(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    _classCallCheck(this, Voice);

    this.creds = credentials;
    this.options = options;
  }

  _createClass(Voice, [{
    key: "_sendVoiceMessage",
    value: function _sendVoiceMessage(endpoint, data, callback) {
      if (!data.to) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.to));
      } else {
        data["api_key"] = this.creds.apiKey;
        data["api_secret"] = this.creds.apiSecret;
        this.options.logger.info("sending TTS message to " + data.to + " with message " + data.text);
        this.options.httpClient.request({
          host: endpoint.host,
          path: _Utils2.default.createPathWithQuery(endpoint.path, data)
        }, "POST", function (err, apiResponse) {
          if (!err && apiResponse.status && apiResponse.status > 0) {
            _Utils2.default.sendError(callback, new Error(apiResponse["error-text"]), apiResponse);
          } else {
            if (callback) callback(err, apiResponse);
          }
        });
      }
    }

    /**
     * TODO: document
     */

  }, {
    key: "sendTTSMessage",
    value: function sendTTSMessage(recipient, message, opts, callback) {
      if (!message) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
      } else {
        if (!opts) {
          opts = {};
        }
        opts["to"] = recipient;
        opts["text"] = message;
        this._sendVoiceMessage({
          host: this.options.apiHost || "api.nexmo.com",
          path: "/tts/json"
        }, opts, callback);
      }
    }

    /**
     * TODO: remove with next major version, API is 404
     */

  }, {
    key: "sendTTSPromptWithCapture",
    value: function sendTTSPromptWithCapture(recipient, message, maxDigits, byeText, opts, callback) {
      if (!message) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
      } else if (!maxDigits || isNaN(maxDigits) || maxDigits.length > 16) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.maxDigits));
      } else if (!byeText) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.byeText));
      } else {
        if (!opts) {
          opts = {};
        }
        opts["to"] = recipient;
        opts["text"] = message;
        opts["max_digits"] = maxDigits;
        opts["bye_text"] = byeText;
        this._sendVoiceMessage({
          host: this.options.apiHost || "api.nexmo.com",
          path: "/tts-prompt/json"
        }, opts, callback);
      }
    }

    /**
     * TODO: remove with next major version, API is 404
     */

  }, {
    key: "sendTTSPromptWithConfirm",
    value: function sendTTSPromptWithConfirm(recipient, message, maxDigits, pinCode, byeText, failedText, opts, callback) {
      if (!message) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
      } else if (!maxDigits || isNaN(maxDigits) || maxDigits.length > 16) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.maxDigits));
      } else if (!pinCode || pinCode.length !== maxDigits) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.pinCode));
      } else if (!byeText) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.byeText));
      } else if (!failedText) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.failedText));
      } else {
        if (!opts) {
          opts = {};
        }
        opts["to"] = recipient;
        opts["text"] = message;
        opts["max_digits"] = maxDigits;
        opts["pin_code"] = pinCode;
        opts["bye_text"] = byeText;
        opts["failed_text"] = failedText;
        this._sendVoiceMessage({
          host: this.options.apiHost || "api.nexmo.com",
          path: "/tts-prompt/json"
        }, opts, callback);
      }
    }

    /**
     * TODO: remove with next major version, API is 404
     */

  }, {
    key: "call",
    value: function call(recipient, answerUrl, opts, callback) {
      if (!answerUrl) {
        _Utils2.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.answerUrl));
      } else {
        if (!opts) {
          opts = {};
        }
        opts["to"] = recipient;
        opts["answer_url"] = answerUrl;
        this._sendVoiceMessage({
          host: this.options.restHost || "rest.nexmo.com",
          path: "/call/json"
        }, opts, callback);
      }
    }
  }]);

  return Voice;
}();

exports.default = Voice;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Wb2ljZS5qcyJdLCJuYW1lcyI6WyJWb2ljZSIsInRvIiwibXNnIiwibWF4RGlnaXRzIiwiYnllVGV4dCIsInBpbkNvZGUiLCJmYWlsZWRUZXh0IiwiYW5zd2VyVXJsIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJlbmRwb2ludCIsImRhdGEiLCJjYWxsYmFjayIsInNlbmRFcnJvciIsIkVycm9yIiwiRVJST1JfTUVTU0FHRVMiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJsb2dnZXIiLCJpbmZvIiwidGV4dCIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwiaG9zdCIsInBhdGgiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwiZXJyIiwiYXBpUmVzcG9uc2UiLCJzdGF0dXMiLCJyZWNpcGllbnQiLCJtZXNzYWdlIiwib3B0cyIsIl9zZW5kVm9pY2VNZXNzYWdlIiwiYXBpSG9zdCIsImlzTmFOIiwibGVuZ3RoIiwicmVzdEhvc3QiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQUVBOzs7Ozs7OztJQUVNQSxLOzs7d0JBQ3dCO0FBQzFCLGFBQU87QUFDTEMsWUFBSSxvQkFEQztBQUVMQyxhQUFLLHNCQUZBO0FBR0xDLG1CQUFXLG1DQUhOO0FBSUxDLGlCQUFTLGlDQUpKO0FBS0xDLGlCQUFTLGtDQUxKO0FBTUxDLG9CQUFZLHFDQU5QO0FBT0xDLG1CQUFXO0FBUE4sT0FBUDtBQVNEO0FBQ0Q7Ozs7Ozs7OztBQU1BLGlCQUFZQyxXQUFaLEVBQXVDO0FBQUEsUUFBZEMsT0FBYyx1RUFBSixFQUFJOztBQUFBOztBQUNyQyxTQUFLQyxLQUFMLEdBQWFGLFdBQWI7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWY7QUFDRDs7OztzQ0FFaUJFLFEsRUFBVUMsSSxFQUFNQyxRLEVBQVU7QUFDMUMsVUFBSSxDQUFDRCxLQUFLWCxFQUFWLEVBQWM7QUFDWix3QkFBTWEsU0FBTixDQUFnQkQsUUFBaEIsRUFBMEIsSUFBSUUsS0FBSixDQUFVZixNQUFNZ0Is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QWI7QUFDQUUsYUFBSyxNQUFMLElBQWVELE9BQWY7QUFDQUMsYUFBSyxZQUFMLElBQXFCN0IsU0FBckI7QUFDQTZCLGFBQUssVUFBTCxJQUFtQjNCLE9BQW5CO0FBQ0EyQixhQUFLLFVBQUwsSUFBbUI1QixPQUFuQjtBQUNBNEIsYUFBSyxhQUFMLElBQXNCMUIsVUFBdEI7QUFDQSxhQUFLMkIsaUJBQUwsQ0FDRTtBQUNFVCxnQkFBTSxLQUFLZixPQUFMLENBQWF5QixPQUFiLElBQXdCLGVBRGhDO0FBRUVULGdCQUFNO0FBRlIsU0FERixFQUtFTyxJQUxGLEVBTUVuQixRQU5GO0FBUUQ7QUFDRjs7QUFFRDs7Ozs7O3lCQUdLaUIsUyxFQUFXdkIsUyxFQUFXeUIsSSxFQUFNbkIsUSxFQUFVO0FBQ3pDLFVBQUksQ0FBQ04sU0FBTCxFQUFnQjtBQUNkLHdCQUFNTyxTQUFOLENBQWdCRCxRQUFoQixFQUEwQixJQUFJRSxLQUFKLENBQVVmLE1BQU1nQixjQUFOLENBQXFCVCxTQUEvQixDQUExQjtBQUNELE9BRkQsTUFFTztBQUNMLFlBQUksQ0FBQ3lCLElBQUwsRUFBVztBQUNUQSxpQkFBTyxFQUFQO0FBQ0Q7QUFDREEsYUFBSyxJQUFMLElBQWFGLFNBQWI7QUFDQUUsYUFBSyxZQUFMLElBQXFCekIsU0FBckI7QUFDQSxhQUFLMEIsaUJBQUwsQ0FDRTtBQUNFVCxnQkFBTSxLQUFLZixPQUFMLENBQWE0QixRQUFiLElBQXlCLGdCQURqQztBQUVFWixnQkFBTTtBQUZSLFNBREYsRUFLRU8sSUFMRixFQU1FbkIsUUFORjtBQVFEO0FBQ0Y7Ozs7OztrQkFHWWIsSyIsImZpbGUiOiJWb2ljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuY2xhc3MgVm9pY2Uge1xuICBzdGF0aWMgZ2V0IEVSUk9SX01FU1NBR0VTKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0bzogXCJJbnZhbGlkIHRvIGFkZHJlc3NcIixcbiAgICAgIG1zZzogXCJJbnZhbGlkIFRleHQgTWVzc2FnZVwiLFxuICAgICAgbWF4RGlnaXRzOiBcIkludmFsaWQgbWF4IGRpZ2l0cyBmb3IgVFRTIHByb21wdFwiLFxuICAgICAgYnllVGV4dDogXCJJbnZhbGlkIGJ5ZSB0ZXh0IGZvciBUVFMgcHJvbXB0XCIsXG4gICAgICBwaW5Db2RlOiBcIkludmFsaWQgcGluIGNvZGUgZm9yIFRUUyBjb25maXJtXCIsXG4gICAgICBmYWlsZWRUZXh0OiBcIkludmFsaWQgZmFpbGVkIHRleHQgZm9yIFRUUyBjb25maXJtXCIsXG4gICAgICBhbnN3ZXJVcmw6IFwiSW52YWxpZCBhbnN3ZXIgVVJMIGZvciBjYWxsXCJcbiAgICB9O1xuICB9XG4gIC8qKlxuICAgKiBAcGFyYW0ge0NyZWRlbnRpYWxzfSBjcmVkZW50aWFsc1xuICAgKiAgICBjcmVkZW50aWFscyB0byBiZSB1c2VkIHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgQVBJLlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiAgICBBZGRpdGlvbiAgb3B0aW9ucy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKGNyZWRlbnRpYWxzLCBvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmNyZWRzID0gY3JlZGVudGlhbHM7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgfVxuXG4gIF9zZW5kVm9pY2VNZXNzYWdlKGVuZHBvaW50LCBkYXRhLCBjYWxsYmFjaykge1xuICAgIGlmICghZGF0YS50bykge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMudG8pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGF0YVtcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRzLmFwaUtleTtcbiAgICAgIGRhdGFbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkcy5hcGlTZWNyZXQ7XG4gICAgICB0aGlzLm9wdGlvbnMubG9nZ2VyLmluZm8oXG4gICAgICAgIFwic2VuZGluZyBUVFMgbWVzc2FnZSB0byBcIiArIGRhdGEudG8gKyBcIiB3aXRoIG1lc3NhZ2UgXCIgKyBkYXRhLnRleHRcbiAgICAgICk7XG4gICAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogZW5kcG9pbnQuaG9zdCxcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KGVuZHBvaW50LnBhdGgsIGRhdGEpXG4gICAgICAgIH0sXG4gICAgICAgIFwiUE9TVFwiLFxuICAgICAgICAoZXJyLCBhcGlSZXNwb25zZSkgPT4ge1xuICAgICAgICAgIGlmICghZXJyICYmIGFwaVJlc3BvbnNlLnN0YXR1cyAmJiBhcGlSZXNwb25zZS5zdGF0dXMgPiAwKSB7XG4gICAgICAgICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgICAgICAgIGNhbGxiYWNrLFxuICAgICAgICAgICAgICBuZXcgRXJyb3IoYXBpUmVzcG9uc2VbXCJlcnJvci10ZXh0XCJdKSxcbiAgICAgICAgICAgICAgYXBpUmVzcG9uc2VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyLCBhcGlSZXNwb25zZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZFRUU01lc3NhZ2UocmVjaXBpZW50LCBtZXNzYWdlLCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMubXNnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghb3B0cykge1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widGV4dFwiXSA9IG1lc3NhZ2U7XG4gICAgICB0aGlzLl9zZW5kVm9pY2VNZXNzYWdlKFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogXCIvdHRzL2pzb25cIlxuICAgICAgICB9LFxuICAgICAgICBvcHRzLFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogcmVtb3ZlIHdpdGggbmV4dCBtYWpvciB2ZXJzaW9uLCBBUEkgaXMgNDA0XG4gICAqL1xuICBzZW5kVFRTUHJvbXB0V2l0aENhcHR1cmUoXG4gICAgcmVjaXBpZW50LFxuICAgIG1lc3NhZ2UsXG4gICAgbWF4RGlnaXRzLFxuICAgIGJ5ZVRleHQsXG4gICAgb3B0cyxcbiAgICBjYWxsYmFja1xuICApIHtcbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLm1zZykpO1xuICAgIH0gZWxzZSBpZiAoIW1heERpZ2l0cyB8fCBpc05hTihtYXhEaWdpdHMpIHx8IG1heERpZ2l0cy5sZW5ndGggPiAxNikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMubWF4RGlnaXRzKSk7XG4gICAgfSBlbHNlIGlmICghYnllVGV4dCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMuYnllVGV4dCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIW9wdHMpIHtcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInRleHRcIl0gPSBtZXNzYWdlO1xuICAgICAgb3B0c1tcIm1heF9kaWdpdHNcIl0gPSBtYXhEaWdpdHM7XG4gICAgICBvcHRzW1wiYnllX3RleHRcIl0gPSBieWVUZXh0O1xuICAgICAgdGhpcy5fc2VuZFZvaWNlTWVzc2FnZShcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgICAgIHBhdGg6IFwiL3R0cy1wcm9tcHQvanNvblwiXG4gICAgICAgIH0sXG4gICAgICAgIG9wdHMsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiByZW1vdmUgd2l0aCBuZXh0IG1ham9yIHZlcnNpb24sIEFQSSBpcyA0MDRcbiAgICovXG4gIHNlbmRUVFNQcm9tcHRXaXRoQ29uZmlybShcbiAgICByZWNpcGllbnQsXG4gICAgbWVzc2FnZSxcbiAgICBtYXhEaWdpdHMsXG4gICAgcGluQ29kZSxcbiAgICBieWVUZXh0LFxuICAgIGZhaWxlZFRleHQsXG4gICAgb3B0cyxcbiAgICBjYWxsYmFja1xuICApIHtcbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLm1zZykpO1xuICAgIH0gZWxzZSBpZiAoIW1heERpZ2l0cyB8fCBpc05hTihtYXhEaWdpdHMpIHx8IG1heERpZ2l0cy5sZW5ndGggPiAxNikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMubWF4RGlnaXRzKSk7XG4gICAgfSBlbHNlIGlmICghcGluQ29kZSB8fCBwaW5Db2RlLmxlbmd0aCAhPT0gbWF4RGlnaXRzKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5waW5Db2RlKSk7XG4gICAgfSBlbHNlIGlmICghYnllVGV4dCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMuYnllVGV4dCkpO1xuICAgIH0gZWxzZSBpZiAoIWZhaWxlZFRleHQpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLmZhaWxlZFRleHQpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFvcHRzKSB7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0ZXh0XCJdID0gbWVzc2FnZTtcbiAgICAgIG9wdHNbXCJtYXhfZGlnaXRzXCJdID0gbWF4RGlnaXRzO1xuICAgICAgb3B0c1tcInBpbl9jb2RlXCJdID0gcGluQ29kZTtcbiAgICAgIG9wdHNbXCJieWVfdGV4dFwiXSA9IGJ5ZVRleHQ7XG4gICAgICBvcHRzW1wiZmFpbGVkX3RleHRcIl0gPSBmYWlsZWRUZXh0O1xuICAgICAgdGhpcy5fc2VuZFZvaWNlTWVzc2FnZShcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgICAgIHBhdGg6IFwiL3R0cy1wcm9tcHQvanNvblwiXG4gICAgICAgIH0sXG4gICAgICAgIG9wdHMsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiByZW1vdmUgd2l0aCBuZXh0IG1ham9yIHZlcnNpb24sIEFQSSBpcyA0MDRcbiAgICovXG4gIGNhbGwocmVjaXBpZW50LCBhbnN3ZXJVcmwsIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFhbnN3ZXJVcmwpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLmFuc3dlclVybCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIW9wdHMpIHtcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcImFuc3dlcl91cmxcIl0gPSBhbnN3ZXJVcmw7XG4gICAgICB0aGlzLl9zZW5kVm9pY2VNZXNzYWdlKFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLnJlc3RIb3N0IHx8IFwicmVzdC5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBcIi9jYWxsL2pzb25cIlxuICAgICAgICB9LFxuICAgICAgICBvcHRzLFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVm9pY2U7XG4iXX0=